---
description: Testing guidelines and patterns for lbxd
globs: ["**/tests/**/*.rs", "**/*_test.rs", "**/test_*.rs"]
---

# Testing Guidelines

## Test Structure

Tests live in two places:
1. **Unit tests**: In-module `#[cfg(test)]` blocks
2. **Integration tests**: `tests/` directory

## Unit Test Pattern

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_parse_rating() {
        assert_eq!(parse_rating("★★★★"), Some(4.0));
        assert_eq!(parse_rating("★★★½"), Some(3.5));
        assert_eq!(parse_rating(""), None);
    }

    #[tokio::test]
    async fn test_fetch_user() {
        let client = LetterboxdClient::new();
        let result = client.fetch_user("testuser").await;
        assert!(result.is_ok());
    }
}
```

## Test Naming

Use descriptive names:
```rust
#[test]
fn parse_rating_returns_none_for_empty_string() { }

#[test]
fn cache_expires_after_ttl() { }

#[test]
fn export_creates_valid_json() { }
```

## Async Testing

Use `#[tokio::test]` for async tests:

```rust
#[tokio::test]
async fn test_api_timeout() {
    let client = TmdbClient::new();
    let result = client.search("nonexistent").await;
    // Verify timeout behavior
}
```

## Mocking

For network tests, consider:
1. **Mock servers** with `wiremock`
2. **Cached responses** in test fixtures
3. **Skip in CI** with `#[ignore]`

```rust
#[tokio::test]
#[ignore] // Requires network
async fn test_real_api() {
    // ...
}
```

## Panic Safety

Test panic recovery:

```rust
#[test]
fn handles_invalid_input_without_panic() {
    let result = std::panic::catch_unwind(|| {
        parse_dangerous_input("malformed");
    });
    assert!(result.is_ok());
}
```

## Test Commands

```bash
cargo test                    # All tests
cargo test test_name          # Specific test
cargo test --verbose          # Show output
cargo test -- --nocapture     # Show println
cargo test -- --ignored       # Run ignored tests
```

## What to Test

1. **Input parsing** - Edge cases, invalid input
2. **Error handling** - Network failures, missing data
3. **Data transformations** - Serialization, formatting
4. **Cache behavior** - TTL, invalidation
5. **CLI parsing** - Argument combinations

## What NOT to Test

1. External API behavior (mock instead)
2. Terminal rendering (visual inspection)
3. Obvious Rust stdlib behavior
