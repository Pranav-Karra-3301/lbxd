---
description: Guidelines for API client implementations (TMDB, OMDB, Letterboxd)
globs: ["src/tmdb/**/*.rs", "src/omdb/**/*.rs", "src/letterboxd_client_rust/**/*.rs", "src/feed/**/*.rs"]
---

# API Client Guidelines

## Structure

Each API client should follow this pattern:

```rust
pub struct ApiClient {
    client: reqwest::Client,
    base_url: String,
    api_key: Option<String>,
}

impl ApiClient {
    pub fn new() -> Self {
        let api_key = std::env::var("API_KEY").ok()
            .or_else(|| Some(DEFAULT_KEY.to_string()));

        Self {
            client: reqwest::Client::new(),
            base_url: "https://api.example.com".to_string(),
            api_key,
        }
    }
}
```

## API Key Handling

**Built-in defaults** allow zero-config usage:

```rust
const DEFAULT_TMDB_KEY: &str = "...";  // Built-in key
const DEFAULT_OMDB_KEY: &str = "...";  // Built-in key

// Environment variable overrides built-in
let key = std::env::var("TMDB_API_KEY")
    .unwrap_or_else(|_| DEFAULT_TMDB_KEY.to_string());
```

## Request Patterns

Always include:
1. **Timeout** - 30 seconds default
2. **User-Agent** - Identify the application
3. **Error handling** - Check status codes

```rust
pub async fn fetch(&self, endpoint: &str) -> anyhow::Result<Response> {
    let url = format!("{}/{}", self.base_url, endpoint);

    let response = self.client
        .get(&url)
        .header("User-Agent", "lbxd-cli")
        .timeout(Duration::from_secs(30))
        .send()
        .await?;

    if !response.status().is_success() {
        anyhow::bail!("API error: {} - {}", response.status(), url);
    }

    Ok(response)
}
```

## Response Parsing

Use serde for JSON:

```rust
#[derive(Debug, Deserialize)]
pub struct MovieResponse {
    pub id: u64,
    pub title: String,
    pub release_date: Option<String>,
    #[serde(default)]
    pub vote_average: f64,
}

let movie: MovieResponse = response.json().await?;
```

## Rate Limiting

Respect API limits:
- TMDB: 40 requests per 10 seconds
- OMDB: 1000 requests per day (free tier)
- Letterboxd: Be gentle (no official API)

## Caching Integration

Always use the cache system:

```rust
// Check cache first
if let Some(cached) = cache.get(&cache_key).await? {
    return Ok(cached);
}

// Fetch and cache
let data = self.fetch(endpoint).await?;
cache.set(&cache_key, &data).await?;
Ok(data)
```

## Error Handling

Specific error types:

```rust
match response.status() {
    StatusCode::NOT_FOUND => anyhow::bail!("Movie not found"),
    StatusCode::UNAUTHORIZED => anyhow::bail!("Invalid API key"),
    StatusCode::TOO_MANY_REQUESTS => anyhow::bail!("Rate limited"),
    status if !status.is_success() => anyhow::bail!("API error: {}", status),
    _ => {}
}
```
